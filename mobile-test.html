<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Mobile QR Test - QR Attendance</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            color: #333;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 20px;
            padding: 20px 0;
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .test-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .test-section {
            margin-bottom: 25px;
        }

        .test-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
            display: flex;
            align-items: center;
        }

        .test-title::before {
            content: '';
            width: 4px;
            height: 20px;
            background: #667eea;
            margin-right: 10px;
            border-radius: 2px;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 10px;
            transition: all 0.3s ease;
            text-align: center;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .qr-container {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            margin: 15px 0;
        }

        #testQRCode {
            margin: 0 auto;
        }

        .scanner-container {
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
            position: relative;
        }

        #mobileReader {
            width: 100%;
            border-radius: 10px;
        }

        .status-indicator {
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
            text-align: center;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .test-log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }

        .feature-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: center;
            font-size: 14px;
        }

        .feature-check {
            color: #28a745;
            font-weight: bold;
        }

        .feature-cross {
            color: #dc3545;
            font-weight: bold;
        }

        /* Mobile-specific styles */
        @media (max-width: 480px) {
            .container {
                padding: 0 5px;
            }
            
            .test-card {
                padding: 15px;
            }
            
            .btn {
                padding: 12px;
                font-size: 14px;
            }
            
            .feature-grid {
                grid-template-columns: 1fr;
                gap: 8px;
            }
        }

        /* Camera permissions styling */
        .camera-permission {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
        }

        .device-info {
            background: #e2e3e5;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì± Mobile QR Test</h1>
            <p>Complete mobile testing suite</p>
        </div>

        <!-- Device Information -->
        <div class="test-card">
            <div class="test-section">
                <div class="test-title">üì± Device Information</div>
                <div class="device-info" id="deviceInfo">
                    Loading device information...
                </div>
                <button class="btn btn-primary" onclick="checkDeviceCapabilities()">
                    Check Device Capabilities
                </button>
            </div>
        </div>

        <!-- Camera Test -->
        <div class="test-card">
            <div class="test-section">
                <div class="test-title">üì∑ Camera Test</div>
                <div class="camera-permission">
                    <strong>‚ö†Ô∏è Camera Permission Required</strong><br>
                    This test requires camera access to work properly.
                </div>
                <button class="btn btn-warning" onclick="testCameraAccess()">
                    Test Camera Access
                </button>
                <div id="cameraStatus" class="status-indicator" style="display: none;"></div>
            </div>
        </div>

        <!-- QR Generation Test -->
        <div class="test-card">
            <div class="test-section">
                <div class="test-title">üî≤ QR Generation Test</div>
                <button class="btn btn-primary" onclick="generateTestQR()">
                    Generate Test QR Code
                </button>
                <div class="qr-container" id="qrContainer" style="display: none;">
                    <div id="testQRCode"></div>
                    <p id="qrDataDisplay"></p>
                </div>
            </div>
        </div>

        <!-- QR Scanning Test -->
        <div class="test-card">
            <div class="test-section">
                <div class="test-title">üì∏ QR Scanning Test</div>
                <button class="btn btn-success" onclick="startMobileScanner()" id="startScanBtn">
                    Start QR Scanner
                </button>
                <button class="btn btn-danger" onclick="stopMobileScanner()" id="stopScanBtn" style="display: none;">
                    Stop Scanner
                </button>
                <div class="scanner-container" id="scannerContainer" style="display: none;">
                    <div id="mobileReader"></div>
                </div>
                <div id="scanStatus" class="status-indicator" style="display: none;"></div>
            </div>
        </div>

        <!-- Feature Compatibility -->
        <div class="test-card">
            <div class="test-section">
                <div class="test-title">‚úÖ Feature Compatibility</div>
                <div class="feature-grid" id="featureGrid">
                    <!-- Features will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Test Results -->
        <div class="test-card">
            <div class="test-section">
                <div class="test-title">üìä Test Results</div>
                <div id="testResults">
                    <p>Run the tests above to see results here.</p>
                </div>
                <button class="btn btn-primary" onclick="runAllMobileTests()">
                    üöÄ Run All Tests
                </button>
                <div class="test-log" id="testLog" style="display: none;"></div>
            </div>
        </div>
    </div>

    <script>
        let html5QrcodeScanner;
        let testResults = {};

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateDeviceInfo();
            checkFeatureCompatibility();
            logMessage('Mobile test page loaded');
        });

        function updateDeviceInfo() {
            const info = {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                language: navigator.language,
                cookieEnabled: navigator.cookieEnabled,
                onLine: navigator.onLine,
                screenWidth: screen.width,
                screenHeight: screen.height,
                viewportWidth: window.innerWidth,
                viewportHeight: window.innerHeight,
                pixelRatio: window.devicePixelRatio,
                touchSupport: 'ontouchstart' in window,
                geolocation: 'geolocation' in navigator,
                camera: 'mediaDevices' in navigator && 'getUserMedia' in navigator.mediaDevices
            };

            const deviceInfoHtml = `
                <strong>Device:</strong> ${getMobileDeviceType()}<br>
                <strong>Browser:</strong> ${getBrowserInfo()}<br>
                <strong>Screen:</strong> ${info.screenWidth}√ó${info.screenHeight} (${info.pixelRatio}x)<br>
                <strong>Viewport:</strong> ${info.viewportWidth}√ó${info.viewportHeight}<br>
                <strong>Touch:</strong> ${info.touchSupport ? '‚úÖ' : '‚ùå'}<br>
                <strong>Camera API:</strong> ${info.camera ? '‚úÖ' : '‚ùå'}<br>
                <strong>Online:</strong> ${info.onLine ? '‚úÖ' : '‚ùå'}
            `;

            document.getElementById('deviceInfo').innerHTML = deviceInfoHtml;
        }

        function getMobileDeviceType() {
            const ua = navigator.userAgent;
            if (/iPad|iPhone|iPod/.test(ua)) return 'iOS Device';
            if (/Android/.test(ua)) return 'Android Device';
            if (/Windows Phone/.test(ua)) return 'Windows Phone';
            return 'Desktop/Other';
        }

        function getBrowserInfo() {
            const ua = navigator.userAgent;
            if (ua.includes('Chrome')) return 'Chrome';
            if (ua.includes('Safari') && !ua.includes('Chrome')) return 'Safari';
            if (ua.includes('Firefox')) return 'Firefox';
            if (ua.includes('Edge')) return 'Edge';
            return 'Unknown';
        }

        function checkFeatureCompatibility() {
            const features = [
                { name: 'Camera API', test: () => 'mediaDevices' in navigator && 'getUserMedia' in navigator.mediaDevices },
                { name: 'Touch Events', test: () => 'ontouchstart' in window },
                { name: 'Local Storage', test: () => typeof Storage !== 'undefined' },
                { name: 'Geolocation', test: () => 'geolocation' in navigator },
                { name: 'WebRTC', test: () => 'RTCPeerConnection' in window },
                { name: 'Service Worker', test: () => 'serviceWorker' in navigator },
                { name: 'Push Notifications', test: () => 'Notification' in window },
                { name: 'Vibration API', test: () => 'vibrate' in navigator }
            ];

            const featureGrid = document.getElementById('featureGrid');
            featureGrid.innerHTML = '';

            features.forEach(feature => {
                const supported = feature.test();
                const featureElement = document.createElement('div');
                featureElement.className = 'feature-item';
                featureElement.innerHTML = `
                    <span class="${supported ? 'feature-check' : 'feature-cross'}">
                        ${supported ? '‚úÖ' : '‚ùå'}
                    </span><br>
                    <strong>${feature.name}</strong>
                `;
                featureGrid.appendChild(featureElement);
            });
        }

        function checkDeviceCapabilities() {
            logMessage('Checking device capabilities...');
            
            // Check camera capabilities
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.enumerateDevices()
                    .then(devices => {
                        const cameras = devices.filter(device => device.kind === 'videoinput');
                        logMessage(`Found ${cameras.length} camera(s)`);
                        cameras.forEach((camera, index) => {
                            logMessage(`Camera ${index + 1}: ${camera.label || 'Camera'}`);
                        });
                    })
                    .catch(error => {
                        logMessage(`Error enumerating devices: ${error.message}`);
                    });
            } else {
                logMessage('Camera API not supported');
            }

            // Check screen orientation
            if (screen.orientation) {
                logMessage(`Screen orientation: ${screen.orientation.type}`);
            }

            // Check network connection
            if (navigator.connection) {
                logMessage(`Network: ${navigator.connection.effectiveType || 'Unknown'}`);
            }

            updateDeviceInfo();
        }

        async function testCameraAccess() {
            const statusDiv = document.getElementById('cameraStatus');
            statusDiv.style.display = 'block';
            statusDiv.className = 'status-indicator status-info';
            statusDiv.textContent = 'Requesting camera permission...';

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    } 
                });
                
                statusDiv.className = 'status-indicator status-success';
                statusDiv.textContent = '‚úÖ Camera access granted successfully!';
                
                logMessage('Camera access granted');
                testResults.cameraAccess = true;
                
                // Stop the stream
                stream.getTracks().forEach(track => track.stop());
                
            } catch (error) {
                statusDiv.className = 'status-indicator status-error';
                statusDiv.textContent = `‚ùå Camera access denied: ${error.message}`;
                
                logMessage(`Camera access error: ${error.message}`);
                testResults.cameraAccess = false;
            }
        }

        function generateTestQR() {
            const qrContainer = document.getElementById('qrContainer');
            const qrCodeDiv = document.getElementById('testQRCode');
            const qrDataDisplay = document.getElementById('qrDataDisplay');

            // Clear previous QR code
            qrCodeDiv.innerHTML = '';

            // Generate test data
            const testData = {
                sessionId: `mobile_test_${Date.now()}`,
                classId: 'TEST_CLASS_001',
                className: 'Mobile Test Class',
                timestamp: new Date().toISOString(),
                expiresAt: new Date(Date.now() + 3600000).toISOString(), // 1 hour from now
                type: 'attendance_session'
            };

            logMessage('Generating test QR code...');

            QRCode.toCanvas(qrCodeDiv, JSON.stringify(testData), {
                width: 200,
                margin: 2,
                color: {
                    dark: '#000000',
                    light: '#FFFFFF'
                }
            }, function(error) {
                if (error) {
                    logMessage(`QR generation error: ${error.message}`);
                    testResults.qrGeneration = false;
                } else {
                    qrContainer.style.display = 'block';
                    qrDataDisplay.textContent = `Session: ${testData.sessionId}`;
                    logMessage('QR code generated successfully');
                    testResults.qrGeneration = true;
                }
            });
        }

        function startMobileScanner() {
            const scannerContainer = document.getElementById('scannerContainer');
            const startBtn = document.getElementById('startScanBtn');
            const stopBtn = document.getElementById('stopScanBtn');
            const statusDiv = document.getElementById('scanStatus');

            scannerContainer.style.display = 'block';
            startBtn.style.display = 'none';
            stopBtn.style.display = 'block';
            statusDiv.style.display = 'block';
            statusDiv.className = 'status-indicator status-info';
            statusDiv.textContent = 'Initializing scanner...';

            logMessage('Starting mobile QR scanner...');

            try {
                html5QrcodeScanner = new Html5QrcodeScanner(
                    "mobileReader",
                    {
                        fps: 10,
                        qrbox: { width: 250, height: 250 },
                        aspectRatio: 1.0,
                        showTorchButtonIfSupported: true,
                        showZoomSliderIfSupported: true,
                        defaultZoomValueIfSupported: 2,
                    }
                );

                html5QrcodeScanner.render(
                    (decodedText, decodedResult) => {
                        statusDiv.className = 'status-indicator status-success';
                        statusDiv.textContent = '‚úÖ QR Code scanned successfully!';
                        
                        logMessage(`QR scanned: ${decodedText.substring(0, 100)}...`);
                        
                        try {
                            const qrData = JSON.parse(decodedText);
                            logMessage(`Parsed QR data: ${JSON.stringify(qrData, null, 2)}`);
                            testResults.qrScanning = true;
                        } catch (e) {
                            logMessage(`QR data (not JSON): ${decodedText}`);
                            testResults.qrScanning = true;
                        }
                        
                        // Auto-stop scanner after successful scan
                        setTimeout(() => stopMobileScanner(), 2000);
                    },
                    (errorMessage) => {
                        // Scanning errors are normal, don't log every frame
                    }
                );

                statusDiv.textContent = 'üì∏ Point camera at QR code to scan';
                logMessage('Scanner initialized successfully');

            } catch (error) {
                statusDiv.className = 'status-indicator status-error';
                statusDiv.textContent = `‚ùå Scanner error: ${error.message}`;
                logMessage(`Scanner initialization error: ${error.message}`);
                testResults.qrScanning = false;
                stopMobileScanner();
            }
        }

        function stopMobileScanner() {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.clear();
                html5QrcodeScanner = null;
            }

            document.getElementById('scannerContainer').style.display = 'none';
            document.getElementById('startScanBtn').style.display = 'block';
            document.getElementById('stopScanBtn').style.display = 'none';
            
            logMessage('Scanner stopped');
        }

        async function runAllMobileTests() {
            logMessage('=== Starting comprehensive mobile tests ===');
            
            // Reset results
            testResults = {};
            
            // Test 1: Device capabilities
            checkDeviceCapabilities();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Test 2: Camera access
            await testCameraAccess();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Test 3: QR generation
            generateTestQR();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Test 4: Show scanner (user needs to manually test)
            logMessage('Manual test required: Use the QR scanner to scan the generated QR code');
            
            // Generate summary
            setTimeout(() => {
                generateMobileTestSummary();
            }, 2000);
        }

        function generateMobileTestSummary() {
            const passed = Object.values(testResults).filter(r => r === true).length;
            const failed = Object.values(testResults).filter(r => r === false).length;
            const total = Object.keys(testResults).length;

            const summary = `
                <h4>üì± Mobile Test Summary</h4>
                <div class="status-${failed === 0 ? 'success' : 'error'}">
                    <strong>Tests Passed:</strong> ${passed}/${total}<br>
                    <strong>Success Rate:</strong> ${total > 0 ? Math.round((passed / total) * 100) : 0}%<br>
                    <strong>Device:</strong> ${getMobileDeviceType()}<br>
                    <strong>Browser:</strong> ${getBrowserInfo()}
                </div>
                ${failed === 0 ? 
                    '<p><strong>üéâ All automated tests passed! Your device is ready for QR attendance.</strong></p>' :
                    '<p><strong>‚ö†Ô∏è Some tests failed. Check the logs for details.</strong></p>'
                }
                <p><small>Manual QR scanning test required for complete verification.</small></p>
            `;

            document.getElementById('testResults').innerHTML = summary;
            logMessage('=== Mobile test summary generated ===');
        }

        function logMessage(message) {
            const logDiv = document.getElementById('testLog');
            logDiv.style.display = 'block';
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[Mobile Test] ${message}`);
        }

        // Handle orientation change
        window.addEventListener('orientationchange', function() {
            setTimeout(() => {
                updateDeviceInfo();
                logMessage('Orientation changed');
            }, 500);
        });

        // Handle visibility change (app switching)
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && html5QrcodeScanner) {
                logMessage('App went to background, stopping scanner');
                stopMobileScanner();
            }
        });
    </script>
</body>
</html>
